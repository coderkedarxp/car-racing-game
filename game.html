<!DOCTYPE html>
<html>
  <head>
    <title>Racing Game - Multiplayer</title>
    <style>
      body {
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        background: #333;
        height: 100vh;
        overflow: hidden;
      }
      #usernameDisplay {
        color: white;
        font-size: 20px;
        margin: 10px;
      }
      #gameCanvas {
        border: 1px solid black;
        background: #555;
        width: 600px;
        height: 700px; /* Adjusted height */
      }
      #gameOverScreen1,
      #gameOverScreen2 {
        display: none;
        position: absolute;
        top: 50%;
        width: 200px;
        text-align: center;
        color: white;
        font-size: 30px;
        font-family: Arial, sans-serif;
        z-index: 10;
        background: rgba(0, 0, 0, 0.7);
        padding: 10px;
        border-radius: 5px;
      }
      #gameOverScreen1 {
        left: 150px;
        transform: translate(-50%, -50%);
      }
      #gameOverScreen2 {
        left: 450px;
        transform: translate(-50%, -50%);
      }
      .backButton {
        margin-top: 20px;
        padding: 10px 20px;
        font-size: 16px;
        background-color: #4caf50;
        color: white;
        border: none;
        cursor: pointer;
        text-decoration: none;
        display: none;
      }
      .backButton:hover {
        background-color: #45a049;
      }
    </style>
  </head>
  <body>
    <div id="usernameDisplay"></div>
    <canvas id="gameCanvas"></canvas>
    <div id="gameOverScreen1">
      <div>Game Over</div>
      <a href="index.html" class="backButton" id="backButton1">Back to Menu</a>
    </div>
    <div id="gameOverScreen2">
      <div>Game Over</div>
      <a href="index.html" class="backButton" id="backButton2">Back to Menu</a>
    </div>
    <script>
      const canvas = document.getElementById("gameCanvas");
      const ctx = canvas.getContext("2d");
      const roadWidth = 200;
      const road1X = 50;
      const road2X = 350;
      const carWidth = 40,
        carHeight = 60;
      const obstacleWidth = 40,
        obstacleHeight = 60;
      const laneLeftOffset = roadWidth / 4;
      const laneRightOffset = (3 * roadWidth) / 4;

      let player1 = {
        x: road1X + laneLeftOffset,
        angle: 0,
        targetAngle: 0,
        lane: "left",
        gameOver: false,
        score: 0,
      };
      let player2 = {
        x: road2X + laneLeftOffset,
        angle: 0,
        targetAngle: 0,
        lane: "left",
        gameOver: false,
        score: 0,
      };
      let obstacles = [];
      let gameTime = 0,
        baseSpeed = 3,
        speed = baseSpeed,
        dashOffset = 0;

      const playerCarImg = new Image();
      playerCarImg.src = "images/playerCar.png";
      const obstacleCars = [new Image(), new Image(), new Image()];
      obstacleCars[0].src = "images/obstacleCarBlue.png";
      obstacleCars[1].src = "images/obstacleCarGreen.png";
      obstacleCars[2].src = "images/obstacleCarWhite.png";
      const obstacleImageMap = {
        "obstacleCarBlue.png": obstacleCars[0],
        "obstacleCarGreen.png": obstacleCars[1],
        "obstacleCarWhite.png": obstacleCars[2],
      };

      const socket = new WebSocket("wss://racing-game-server.onrender.com");
      let playerId = null;
      let gameStarted = false;

      socket.onopen = () => {
        console.log("WebSocket connected");
        player1 = {
          x: road1X + laneLeftOffset,
          angle: 0,
          targetAngle: 0,
          lane: "left",
          gameOver: false,
          score: 0,
        };
        player2 = {
          x: road2X + laneLeftOffset,
          angle: 0,
          targetAngle: 0,
          lane: "left",
          gameOver: false,
          score: 0,
        };
        socket.send(
          JSON.stringify({
            type: "join",
            username: localStorage.getItem("username") || "Unknown",
          })
        );
      };
      socket.onmessage = (event) => {
        const data = JSON.parse(event.data);
        console.log("Received:", data);
        if (data.type === "init") {
          playerId = data.playerId;
          document.getElementById(
            "usernameDisplay"
          ).textContent = `Player ${playerId}: ${localStorage.getItem(
            "username"
          )}`;
        } else if (data.type === "start") {
          gameStarted = true;
          document.getElementById("gameOverScreen1").style.display = "none";
          document.getElementById("gameOverScreen2").style.display = "none";
          startGame();
        } else if (data.type === "state") {
          player1.x = data.players[0].x;
          player1.gameOver = data.players[0].gameOver;
          player1.score = data.players[0].score;
          player2.x = data.players[1].x;
          player2.gameOver = data.players[1].gameOver;
          player2.score = data.players[1].score;
          obstacles = data.obstacles;
          speed = data.speed;
          gameTime = data.gameTime;
          dashOffset = data.dashOffset;
        }
      };
      socket.onerror = (error) => {
        console.error("WebSocket error:", error);
        alert("Failed to connect to the game server. Please try again later.");
      };
      socket.onclose = () => console.log("WebSocket closed");

      let imagesLoaded = 0,
        totalImages = 4; // Player car + 3 obstacle cars
      function imageLoaded() {
        imagesLoaded++;
        console.log(`Images loaded: ${imagesLoaded}/${totalImages}`);
        if (imagesLoaded === totalImages) {
          console.log("Images ready, starting game");
          if (playerId) drawCar(playerId === 1 ? player1 : player2);
        }
      }
      function imageError(img) {
        console.error(`Failed to load: ${img.src}`);
      }
      playerCarImg.onload = imageLoaded;
      playerCarImg.onerror = () => imageError(playerCarImg);
      obstacleCars.forEach((img) => {
        img.onload = imageLoaded;
        img.onerror = () => imageError(img);
      });

      canvas.width = 600;
      canvas.height = 700; // Adjusted height

      function drawRoad(x, gameOver) {
        ctx.fillStyle = "gray";
        ctx.fillRect(x, 0, roadWidth, canvas.height);
        ctx.beginPath();
        ctx.setLineDash([50, 20]);
        ctx.strokeStyle = "white";
        ctx.lineWidth = 4;
        ctx.lineDashOffset = gameOver ? 0 : dashOffset;
        ctx.moveTo(x + roadWidth / 2, 0);
        ctx.lineTo(x + roadWidth / 2, canvas.height);
        ctx.stroke();
        ctx.setLineDash([]);
      }

      function drawCar(player) {
        ctx.save();
        ctx.translate(player.x, canvas.height - carHeight / 2 - 10);
        ctx.rotate(player.angle);
        ctx.drawImage(
          playerCarImg,
          -carWidth / 2,
          -carHeight / 2,
          carWidth,
          carHeight
        );
        ctx.restore();
      }

      document.addEventListener("keydown", (e) => {
        if (playerId) {
          let player = playerId === 1 ? player1 : player2;
          let roadX = playerId === 1 ? road1X : road2X;
          if (!player.gameOver) {
            if (e.key === "ArrowLeft" && player.lane !== "left") {
              player.targetX = roadX + laneLeftOffset;
              player.targetAngle = -0.26;
              player.lane = "left";
              socket.send(
                JSON.stringify({ type: "move", playerId, x: player.targetX })
              );
            } else if (e.key === "ArrowRight" && player.lane !== "right") {
              player.targetX = roadX + laneRightOffset;
              player.targetAngle = 0.26;
              player.lane = "right";
              socket.send(
                JSON.stringify({ type: "move", playerId, x: player.targetX })
              );
            }
          }
        }
      });

      function startGame() {
        console.log("Starting game");
        gameLoop();
      }

      function gameLoop() {
        try {
          if (!gameStarted) return;
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          drawRoad(road1X, player1.gameOver);
          drawRoad(road2X, player2.gameOver);

          const moveSpeed = 0.2;
          [player1, player2].forEach((player) => {
            player.angle += (player.targetAngle - player.angle) * moveSpeed;
            if (Math.abs(player.targetAngle - player.angle) < 0.01) {
              player.angle = player.targetAngle;
              if (player.x === player.targetX) player.targetAngle = 0;
            }
            if (!player.gameOver) drawCar(player);
          });

          obstacles.forEach((o) => {
            const img = obstacleImageMap[o.img];
            if (img) {
              // Draw for Player 1 (road1X = 50)
              if (!player1.gameOver) {
                ctx.drawImage(
                  img,
                  o.x - obstacleWidth / 2,
                  o.y,
                  obstacleWidth,
                  obstacleHeight
                );
              }
              // Draw for Player 2 (road2X = 350)
              if (!player2.gameOver) {
                let player2X;
                if (o.side === "left") {
                  player2X = o.x + 300; // Shift Player 1's left obstacle to Player 2's left lane
                } else {
                  // o.side === 'right'
                  player2X = o.x + 300 - 100; // Shift Player 1's right obstacle to Player 2's right lane
                }
                ctx.drawImage(
                  img,
                  player2X - obstacleWidth / 2,
                  o.y,
                  obstacleWidth,
                  obstacleHeight
                );
              }
            }
          });

          ctx.fillStyle = "white";
          ctx.font = "16px Arial";
          ctx.fillText(`Score: ${Math.floor(player1.score)}`, road1X, 20);
          ctx.fillText(`Score: ${Math.floor(player2.score)}`, road2X, 20);

          document.getElementById("gameOverScreen1").style.display =
            player1.gameOver ? "block" : "none";
          document.getElementById("gameOverScreen2").style.display =
            player2.gameOver ? "block" : "none";
          document.getElementById("backButton1").style.display =
            player1.gameOver && player2.gameOver ? "inline-block" : "none";
          document.getElementById("backButton2").style.display =
            player1.gameOver && player2.gameOver ? "inline-block" : "none";

          if (!player1.gameOver || !player2.gameOver) dashOffset -= speed;
          if (dashOffset <= -70) dashOffset += 70;

          requestAnimationFrame(gameLoop);
        } catch (e) {
          console.error("Game loop error:", e);
        }
      }
    </script>
  </body>
</html>
